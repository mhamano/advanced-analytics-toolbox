{"version":3,"sources":["analysis/logistic_regression_predict.js"],"names":["define","utils","$q","createCube","app","$scope","layout","dimension","validateDimension","props","dimensions","qNullSuppression","qDef","qFieldDefs","meaLen","measures","length","rowsLabel","label","validateMeasure","params","meaList","dataType","i","mea","param","push","splitData","splitPercentage","displayDebugModeMessage","debugMode","saveRDataset","getDebugSaveDatasetScript","defMea1","displayRScriptsToConsole","qLabel","backendApi","applyPatches","qPath","qOp","qValue","JSON","stringify","patchApplied","drawChart","defer","requestPage","qTop","qLeft","qWidth","qHeight","getData","then","dataPages","qMatrix","qText","displayConnectionError","extId","displayReturnedDatasetToConsole","result","parse","rowLabels","columnLabels","data","numOfRows","roundWithDecimals","n","decimals","Math","round","pow","html","accuracyDenominator","accuracyNumerator","precisions","recallDenominator","recallNumerator","recalls","j","precisionDenominator","precisionNumerator","rpartMethod","sum","arr","reduce","prev","current","average","fn","$","resolve","promise"],"mappings":"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","file":"../../js/analysis/logistic_regression_predict.js","sourcesContent":["define([\r\n  '../util/utils',\r\n  'ng!$q',\r\n], (utils, $q) => {\r\n  return {\r\n    /**\r\n     * createCube - create HyperCubes\r\n     *\r\n     * @param {Object} app    reference to app\r\n     * @param {Object} $scope angular $scope\r\n     *\r\n     * @return {Null} null\r\n     */\r\n    createCube(app, $scope) {\r\n      const layout = $scope.layout;\r\n\r\n      // Display loader\r\n      // utils.displayLoader($scope.extId);\r\n\r\n      // Set definitions for dimensions and measures\r\n      const dimension = utils.validateDimension(layout.props.dimensions[0]);\r\n      const dimensions = [{\r\n        qNullSuppression: true,\r\n        qDef: {\r\n          qFieldDefs: [dimension]\r\n        },\r\n      }];\r\n\r\n      const meaLen = layout.props.measures.length;\r\n      $scope.rowsLabel = ['(Intercept)', (layout.props.measures[1].label != '') ? layout.props.measures[1].label : utils.validateMeasure(layout.props.measures[0]) ]; // Label for dimension values\r\n      let params = `${utils.validateMeasure(layout.props.measures[0])} as mea0, ${utils.validateMeasure(layout.props.measures[1])} as mea1`;\r\n      let meaList = 'mea0 ~ mea1';\r\n      let dataType = 'NN';\r\n\r\n      for (let i = 2; i < meaLen; i++) {\r\n        const mea = utils.validateMeasure(layout.props.measures[i]);\r\n        if (mea.length > 0) {\r\n          const param = `,${mea} as mea${i}`;\r\n          params += param;\r\n          meaList += ` + mea${i}`;\r\n          dataType += 'N';\r\n\r\n          $scope.rowsLabel.push(utils.validateMeasure(layout.props.measures[i]));\r\n        }\r\n      }\r\n\r\n      // Split dataset into training and test datasets\r\n      const splitData = utils.splitData(true, layout.props.splitPercentage, meaLen);\r\n\r\n      // Debug mode - set R dataset name to store the q data.\r\n      utils.displayDebugModeMessage(layout.props.debugMode);\r\n      const saveRDataset = utils.getDebugSaveDatasetScript(layout.props.debugMode, 'debug_logistic_regression_predict.rda');\r\n\r\n      const defMea1 = `R.ScriptEvalExStr('${dataType}','${saveRDataset} library(jsonlite); ${splitData} lm_result <- glm(${meaList}, data=training_data, family=binomial(link=\"logit\"));lm_summary <- summary(lm_result);\r\n      pred <- predict(lm_result, test_data, type=\"response\"); pred_result <- ifelse(pred > 0.5,1,0); act_result <- ifelse(test_data$mea0 > 0.5,1,0); conf.mat<-table(pred_result, act_result);\r\n      json<-toJSON(list(list(attributes(conf.mat)$dimnames[[1]], attributes(conf.mat)$dimnames[[2]]), unname(split(conf.mat, seq(nrow(conf.mat)))), c(length(training_data$mea0), length(test_data$mea0))));json;',${params})`;\r\n\r\n      // Debug mode - display R Scripts to console\r\n      utils.displayRScriptsToConsole(layout.props.debugMode, [defMea1]);\r\n\r\n      const measures = [\r\n        {\r\n          qDef: {\r\n            qDef: defMea1,\r\n          },\r\n        },\r\n        {\r\n          qDef: {\r\n            qLabel: '-',\r\n            qDef: '', // Dummy\r\n          },\r\n        },\r\n        {\r\n          qDef: {\r\n            qLabel: '-',\r\n            qDef: '', // Dummy\r\n          },\r\n        },\r\n        {\r\n          qDef: {\r\n            qLabel: '-',\r\n            qDef: '', // Dummy\r\n          },\r\n        },\r\n        {\r\n          qDef: {\r\n            qLabel: '-',\r\n            qDef: '', // Dummy\r\n          },\r\n        },\r\n      ];\r\n\r\n      $scope.backendApi.applyPatches([\r\n        {\r\n          qPath: '/qHyperCubeDef/qDimensions',\r\n          qOp: 'replace',\r\n          qValue: JSON.stringify(dimensions),\r\n        },\r\n        {\r\n          qPath: '/qHyperCubeDef/qMeasures',\r\n          qOp: 'replace',\r\n          qValue: JSON.stringify(measures),\r\n        },\r\n      ], false);\r\n\r\n      $scope.patchApplied = true;\r\n      return null;\r\n    },\r\n    /**\r\n    * drawChart - draw chart with updated data\r\n    *\r\n    * @param {Object} $scope angular $scope\r\n    *\r\n    * @return {Object} Promise object\r\n    */\r\n    drawChart($scope) {\r\n      const defer = $q.defer();\r\n      const layout = $scope.layout;\r\n\r\n      const dimension = utils.validateDimension(layout.props.dimensions[0]);\r\n      const requestPage = [{\r\n        qTop: 0,\r\n        qLeft: 0,\r\n        qWidth: 2,\r\n        qHeight: 1,\r\n      }];\r\n\r\n      $scope.backendApi.getData(requestPage).then((dataPages) => {\r\n        // Display error when all measures' grand total return NaN.\r\n        if (dataPages[0].qMatrix[0][1].qText.length === 0 || dataPages[0].qMatrix[0][1].qText == '-') {\r\n          utils.displayConnectionError($scope.extId);\r\n        } else {\r\n          // Debug mode - display returned dataset to console\r\n          utils.displayReturnedDatasetToConsole(layout.props.debugMode, dataPages[0]);\r\n\r\n          const result = JSON.parse(dataPages[0].qMatrix[0][1].qText);\r\n\r\n          const rowLabels = result[0][0];\r\n          const columnLabels = result[0][1];\r\n          const data = result[1];\r\n          const numOfRows = result[2];\r\n\r\n          // Helper to round Number\r\n          const roundWithDecimals = (n, decimals) => {\r\n            return Math.round(n * Math.pow(10, decimals)) / Math.pow(10, decimals);\r\n          };\r\n\r\n          // Set table header for cunfusion matrix\r\n          let html = `\r\n            <h2>Confusion matrix:</h2>\r\n            <table class=\"simple\" >\r\n              <thead>\r\n                <tr>\r\n                  <th rowspan=\"2\" style=\"border-right:none;\"></th><th rowspan=\"2\"></th><th colspan=\"${columnLabels.length + 1}\" style=\"text-align:center\">Actual class</th>\r\n                </tr>\r\n                <tr>\r\n                  `;\r\n\r\n          for (let i = 0; i < columnLabels.length; i++) {\r\n            html += `<th>${columnLabels[i]}</th>`;\r\n          }\r\n\r\n          html += `<th>Precision</th></tr>\r\n            </thead>\r\n            <tbody>`;\r\n\r\n          // Set table body for cunfusion matrix\r\n          let accuracyDenominator = 0;\r\n          let accuracyNumerator = 0;\r\n          const precisions = [];\r\n          const recallDenominator = [];\r\n          const recallNumerator = [];\r\n          const recalls = [];\r\n\r\n          // Initialize recallDenominator and recallNumerator with zeros\r\n          for (let j = 0; j < columnLabels.length; j++) {\r\n            recallDenominator[j] = 0;\r\n            recallNumerator[j] = 0;\r\n          }\r\n\r\n          // Repeat evey row\r\n          for (let i = 0; i < rowLabels.length; i++) {\r\n            if (i === 0) {\r\n              html += `<tr><td rowspan=\"${rowLabels.length + 1}\" style=\"font-weight:bold; white-space:nowrap; width:20px\">Predicted class</td><td style=\"font-weight:bold\">${rowLabels[i]}</td>`;\r\n            } else {\r\n              html += `<tr><td style=\"font-weight:bold\">${rowLabels[i]}</td>`;\r\n            }\r\n\r\n            let precisionDenominator = 0;\r\n            let precisionNumerator = 0;\r\n            // Repease evey column\r\n            for (let j = 0; j < columnLabels.length; j++) {\r\n              accuracyNumerator += data[i][j];\r\n              precisionNumerator += data[i][j];\r\n              recallNumerator[j] += data[i][j];\r\n              if (rowLabels[i] === columnLabels[j]) {\r\n                accuracyDenominator += data[i][j];\r\n                precisionDenominator += data[i][j];\r\n                recallDenominator[j] += data[i][j];\r\n              }\r\n              html += `<td>${data[i][j]}</td>`;\r\n            }\r\n            precisions.push(precisionDenominator / precisionNumerator);\r\n            // Set precisions\r\n            if (layout.props.rpartMethod === 'class') {\r\n              html += `<td>${roundWithDecimals((precisionDenominator / precisionNumerator) * 100, 3)}%</td></tr>`;\r\n            } else {\r\n              html += '<td>-</td></tr>';\r\n            }\r\n          }\r\n\r\n          // Set recalls\r\n          html += '<tr><td style=\"font-weight:bold;\">Recall</td>';\r\n          for (let j = 0; j < recallDenominator.length; j++) {\r\n            if (layout.props.rpartMethod === 'class') {\r\n              html += `<td>${roundWithDecimals((recallDenominator[j] / recallNumerator[j]) * 100, 3)}%</td>`;\r\n            } else {\r\n              html += '<td>-</td>';\r\n            }\r\n            recalls.push(recallDenominator[j] / recallNumerator[j]);\r\n          }\r\n          html += '<td></td></tr>';\r\n\r\n          html += `</tbody>\r\n                  </table>`;\r\n\r\n          // Helpers for calculating performance measures\r\n          const sum = (arr) => {\r\n            return arr.reduce((prev, current, i, arr) => {\r\n              return prev + current;\r\n            });\r\n          };\r\n\r\n          const average = (arr, fn) => {\r\n            return sum(arr, fn) / arr.length;\r\n          };\r\n\r\n          // Set performance measures\r\n          html += `<h2>Performance measures:</h2>\r\n                  <table class=\"simple\" style=\"table-layout:fixed;\">\r\n                    <thead>\r\n                      <tr>\r\n                        <th>Measures</th><th>Results</th>\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                      <tr><td>Accuracy</td><td>${(layout.props.rpartMethod === 'class') ? roundWithDecimals((accuracyDenominator / accuracyNumerator) * 100, 3) + '%' : '-'}</td></tr>\r\n                      <tr><td>Average precision</td><td>${(layout.props.rpartMethod === 'class') ? roundWithDecimals((average(precisions) * 100), 3) + '%' : '-'}</td></tr>\r\n                      <tr><td>Average recall</td><td>${(layout.props.rpartMethod === 'class') ? roundWithDecimals(average(recalls) * 100, 3) + '%' : '-'}</td></tr>\r\n                    </tbody>\r\n                  </table>\r\n                `;\r\n\r\n          // Set number of rows\r\n          html += `<h2>Number of rows:</h2>\r\n                  <table class=\"simple\" style=\"table-layout:fixed;\">\r\n                    <thead>\r\n                      <tr>\r\n                        <th>Datasets</th><th>Number of rows</th>\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                      <tr><td>Training data</td><td>${numOfRows[0]}</td></tr>\r\n                      <tr><td>Test data</td><td>${numOfRows[1]}</td></tr>\r\n                      <tr><td>Total</td><td>${numOfRows[0] + numOfRows[1]}</td></tr>\r\n                    </tbody>\r\n                  </table>\r\n                `;\r\n\r\n          // Set HTML element for chart\r\n          $(`.advanced-analytics-toolsets-${$scope.extId}`).html(html);\r\n        }\r\n        return defer.resolve();\r\n      });\r\n      return defer.promise;\r\n    },\r\n  };\r\n});\r\n"]}